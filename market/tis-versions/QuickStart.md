# TIS平台部署
TIS的愿景是实现企业大数据ETL(Extraction-Transformation-Loading)全覆盖的中台产品，数据抽取（Extraction）是大数据处理所有环节中的第一步，也是最重要的环节。目前TIS平台的定位为DATAOPS，目标是提供一站式、开箱即用的DataOps数据中台。使用体验力争做到大数据领域的Jenkins。

最新版本的TIS数据抽取组件是基于：

Alibaba DataX，并且在原生DataX之上添加了功能特性大大提高了DataX的可用性
实时数据同步框架Flink-CDC和Chunjun

TIS提供了开箱即用的安装包，其本身安装的硬件要求很低，以及很少的系统配置要求和软件依赖，支持单节点和多节点分布式部署。具体要求如下：

## 一、环境要求

准备一台2核4G以上配置的Linux机器节点(CentOs、macOS等)，本次验证使用CentOs 7.5单节点部署方式。

### 1.1 Jdk要求
Java SE Development Kit 8
### 1.2 确保本机节点hostname对应的ip正确
因为进程启动时候会去拿本机的ip地址,所以要保证/etc/hosts文件中hostname 对应ip地址正确。在部署机上做如下配置：
```
  hostname
  # 得到上面显示的结果，例如：baisui-host-1
  ping baisui-host-1
  # 确认ip节点是否为本机ip无误,如不正确，请在/etc/hosts将正确的hostname与ip映射关系加上
```
### 1.3 确保lsof安装成功，如未安装，可通过如下命令用yum进行快速安装：
```
sudo yum install -y lsof
```
### 1.4 准备一个可连通的MySQL或者TiDB数据库作流程体验，百万数据量为佳。
本条不是安装要求，只是参照官网说明，部署后可以快速进行TIS使用体验的推荐。
## 二、部署
因本手册旨在用于指导快速体验TIS，因此仅以单点部署方式进行说明。多点部署方式、开发环境部署、flink集群调用等部署方式请自行参考官网说明(https://tis.pub/):
### 2.1 单点部署
在按照第一部分将单点部署的环境准备好后，就可以进行单点部署操作了，具体步骤如下：
#### 2.1.1 下载
```
wget http://mirror.qlangtech.com/3.6.0-alpha/tis/tis-uber.tar.gz
```
#### 2.1.2 解压
```
tar xvf tis-uber.tar.gz -C ./
```
#### 2.1.3 启动
首先，进入解压后的目录
```
cd tis-uber
```
执行shell启动
```
./bin/tis start
```
TIS同时提供了重启脚本，执行如下命令可以进行快速重启
```
./bin/tis restart
```
终止TIS进程命令
```
./bin/tis stop
```
TIS日志查看
```
tail -f -n 300 ./logs/tis.log
```
TIS启动端口修改
```
vi ./bin/tis
```
里面有一个变量，可修改默认8080为其他端口，重启TIS（./bin/tis restart）即可生效
```
SERVER_PORT=8080
```


## 三、使用初体验
如上步骤可以看到，TIS部署是非常方便的，部署并启动完毕后就可以登录进行体验了。
### 3.1 进入TIS管理控制台
访问http://部署服务器IP:8080就可以进入TIS管理控制台，目前版本平台权限控制还没有集成进来，所以访问改地址就会直接以admin身份登录进来。界面及使用体验确实神似Jenkins。下面就以一个从mysql单表同步的简单示例来感受一下。

#### 3.1.2 Mysql单表同步
1、配置数据源  
正像TIS在首页提示的那样，“所有的一切从定义数据源开始”，该注释写在了“数据源”模块按钮上，那我们第一步就点击该按钮进入数据源模块。  
进入数据源模块页面后，点击页面右上右上角数据源图标按钮，然后选择“添加”,此时右边会数据源类型选择页面，可以看到所有的数据源类型都做成了插件形式，可根据需要选择即使安装使用，这种方式和jenkins使用插件方式很像。也正因为如此也保证了TIS初始安装的轻量、简便。  
本示例选择了“tis-ds-mysql-v5-plugin”插件进行安装，该插件提供了mysql5.x版本的JDBC连接能力。安装好后，在该右侧页面可以看到该插件已进入“已安装”分类tab页列表中。  
此时再重新点击原来页面右上角的数据源图标，现在可以看到除了原来的“添加”之外，多了个“MySQL-V5”,这个就对应我们刚才添加的插件。现在点击“MySQL-V5”，进入配置页面，我们来创建两个数据源，一个是源端，一个是目的端。配置需要设置如下参数：  

**实例ID：**  数据源实例名称，请起一个有意义且唯一的名称  
**数据库名：**  数据库名,创建JDBC实例时用  
**用户名：**  
**密码：**  
**传输压缩：**  如果选择“是”，与服务端通信时采用zlib进行压缩。  
**节点描述：**  支持同时写多个IP，说明支持集群模式连接。  
**端口：**  
**附加参数：**  
**编码：**  目前可选“UTF-8”和“GBK”这两种进行设置。  

配置参数填写完成后，点击配置页面的“校验”按钮，如果能连接成功，就会提示“校验成功”，否则会提醒检查配置。校验成功后就可以点击“保存按钮”，数据源页面的列表中就会出现刚刚添加的数据源。  
2、创建实例  
回到TIS控制台主页，点击“实例”按钮，进入实例模块  
在实例模块页面点击右上角“添加”按钮（该按钮和控制台主页右上角的“添加”按钮作用相同，也可以点击那个进行操作），然后选择“数据管道”，就会进入数据管道的配置页面。  
首先，需要填写该管道的基本信息，有如下字段：  
**实例名称：**  起一个表名用途的名字，注意这里目前不支持“-”符号，而提示示例是用了这个符号的，估计这块后续版本会修复。  
**全局配置：**  本示例使用的默认配置，此处提供了管理配置的按钮，用熟了后可以创建和修改配置。  
**所属部门：**  
**接口人：**  
基本信息填写完，点击“下一步”按钮，进入reader和writer类型指定页面，本示例两个都选的“MySQL”,该页还提供了“插件”按钮，可从本页快速进行所需插件的安装。设置完毕，点击“下一步”，进入Reader的配置页面，该页面需要配置项如下：  
**数据库：**  下拉菜单形式，这里选择之前创建的数据源中用于做源表的那个库连接；  
**splitPk：** 进行数据抽取时，如果指定splitPk，表示用户希望使用splitPk代表的字段进行数据分片，DataX因此会启动并发任务进行数据同步，这样可以大大提供数据同步的效能。为了简便，本示例选择“否”  
**fetchSize：**  执行数据批量导出时单次从数据库中提取记录条数，可以有效减少网络IO次数，提升导出效率。切忌不能设置太大以免OOM发生。本示例使用默认设置的“2000”  
**配置模板：**  提示“无特殊情况请不要修改模版内容，避免不必要的错误”，所以本示例使用默认设置。  
配置完点击“下一步”，进入选表页面，该页面选择要同步的源表，支持多选，选好后点击“>”按钮，待同步源表名称就会转到右侧列表中，进入右侧列表的表，再点击进去设置指定需要同步的字段，还可以添加where条件。在选择多表时，还支持批量设置功能，不过批量设置逻辑是将勾选的表如果未进行过个性设置的，勾选全部字段，及全表同步。为了简便操作，本示例只选了一个表，并选择全部字段的全表同步。点击“保存”按钮后，该表状态由“未配置状态”转为“已配置”。然后点击“下一步”进入writer的配置页面。该页面需要配置的配置项如下：  
**数据库名：**  下拉菜单形式，这里选择之前创建的数据源中用于做目的表的那个库连接；  
**writeMode**  控制写入数据到目标表采用 insert into 或者 replace into 或者 ON DUPLICATE KEY UPDATE 语句。本示例选择“insert”  
**preSql**  写入数据到目的表前，会先执行这里的标准语句。本示例为空  
**postSql**  写入数据到目的表后，会执行这里的标准语句。（原理同 preSql ）本示例为空  
**session**  DataX在获取Mysql连接时，执行session指定的SQL语句，修改当前connection session属性。本示例为空  
**自动建表**  本示例选择“是”，即观察其是否能自动创建目标表。  
**batchSize**  一次性批量提交的记录数大小，该值可以极大减少DataX与Mysql的网络交互次数，并提升整体吞吐量。但是该值设置过大可能会造成DataX运行进程OOM情况。本示例采用默认的“1000”。  
**配置模板**  同reader里的要求一样，无特殊情况请不要修改模版内容，避免不必要的错误。这里也不做修改。  
此页配置完后点击“下一步”，进入源表与目的表对应关系页，默认目的表与源表同名，点击目的表名称，可以进行表名的修改。非常方便。本示例没做更改，即与源表同名。  
然后点击本页的“下一步”，来到确认页面，刚才所有设置的过内容会在这里一并展示。确认后点击“创建”按钮，实例创建成功，并自动跳转到该实例操作页。可以看到在该实例中左侧导航分为如下几个菜单：  
**主控台**  展示统计图表，成功和失败的总次数，并有按日期分组的柱状图展示。  
**配置**  对上一环节创建实例时设置进行查看和维护  
**批量构建**  调用datax进行手动批量同步  
**实时同步**  调用flink进行实时增量同步  
**操作历史**  查看实例的执行历史日志  

3、手动触发批量同步  
本示例只进行“批量构建”测试，点击左侧导航“批量构建”菜单，进入批量构建页面，点击“触发构建”按钮，就会触发实例运行，由于本示例只是选了一个小表，所以只用了10秒的时间整个任务就跑完了，检查了下目的库中目的表自动创建，插入的数据也和源表完全一致。




 

 
 

